## 贡献代码

### 入门指南

在直接为 Swift 语言本身做贡献之前，强烈建议你先在自己的项目中熟悉使用 Swift。我们准备了详细的[入门指南][get_started]，提供了分步说明来帮助你快速上手。

### 渐进式开发

Swift 项目采用*小型、渐进式的变更*作为其首选的开发模式。有时这些变更是小的错误修复。其他时候，这些变更是实现更大目标道路上的小步骤。相比之下，长期开发分支可能会导致社区在开发过程中失去发言权。长期分支还存在以下一些问题：

* 如果分支开发和主线开发在相同的代码部分进行，解决合并冲突可能会花费大量时间。
* 社区成员往往会忽视分支上的工作。
* 非常大的变更很难进行代码审查。
* 分支不会被持续集成基础设施定期测试。

为了解决这些问题，Swift 采用渐进式开发风格。在可能的情况下，优先选择小的变更。我们要求贡献者在进行大型或具有侵入性的变更时遵循这种做法。以下是一些建议：

* 大型或侵入性变更通常需要在主要变更之前进行一些次要变更（例如，API 清理或添加）。在进行主要变更之前，独立提交这些变更。

* 如果可能，将剩余的相互关联的工作分解为互不相关的变更集。然后，定义第一个增量并就变更的开发目标达成共识。

* 使变更集中的每个变更要么是独立的（例如，修复错误），要么是朝着开发目标前进的计划系列变更的一部分。向社区解释这些关系会很有帮助。

如果你想进行大型变更但对其整体影响感到不确定，请务必先通过[开发者论坛](/community/#swift-development)讨论变更并达成共识。然后询问如何最好地进行这个变更。

[email-devs]: mailto:swift-dev@swift.org

### 提交信息

虽然我们不强制要求特定的提交信息格式，但我们建议你遵循以下在开源项目中常见的指导原则。遵循这些指导原则有助于代码审查过程、搜索提交日志和邮件格式化。从高层次来看，提交信息的内容应该传达变更的理由，而不需要深入太多细节。例如，"位没有设置正确"让审查者不清楚是哪些位以及为什么它们不"正确"。相比之下，"在'Type'中正确计算'is dependent type'位"几乎传达了变更的全部内容。

以下是关于提交信息格式本身的一些指导原则：

* 将提交信息分为单行*标题*和描述变更的单独*正文*。
* 使标题简洁，以便在提交日志中易于阅读，并适合作为提交邮件的主题行。
* 在仅限于代码特定部分的变更中，在行首用方括号包含[标签]---例如，"[stdlib] ..."或"[SILGen] ..."。这个标签有助于邮件过滤和提交后审查的搜索。
* 当有正文时，用空行将其与标题分开。
* 使正文简洁，但包含完整的推理。除非理解变更需要，否则额外的代码示例或其他细节应留在错误评论或邮件列表中。
* 如果提交修复了错误跟踪系统中的问题，在信息中包含该问题的链接。
* 对于文本格式和拼写，遵循与文档和代码内注释相同的规则---例如，大写字母和句号的使用。
* 如果提交是在另一个最近提交的变更之上的错误修复，或者是补丁的还原或重新应用，请包含先前相关提交的 Git 修订号，例如"还原 abcdef，因为它导致 bug#"。

对于这些指导原则的轻微违反，社区通常倾向于提醒贡献者这个政策，而不是还原。小的更正和遗漏可以通过向提交邮件列表发送回复来处理。

### 变更归属

当贡献者向 Swift 子项目提交变更时，在该变更被批准后，其他具有提交权限的开发者可以代表作者提交。这样做时，保持正确的贡献归属很重要。一般来说，Git 会自动处理归属。

我们不希望源代码中充斥着像"此代码由 J. Random Hacker 编写"这样随意的归属，这会造成干扰和分散注意力。不要在源代码或文档中添加贡献者姓名。

此外，除非他人已向项目提交了变更，或者你已获得代表他们提交的授权（例如，你们一起工作，你的公司授权你贡献这些变更），否则不要提交他人编写的变更。作者应该首先通过向相关项目提交拉取请求、向开发邮件列表发送邮件或添加错误跟踪器项目来提交变更。如果有人私下向你发送变更，请鼓励他们首先将其提交给适当的列表。

### 代码模板

如[社区概述][community]中所述，Swift.org 代码的许可证和版权保护在每个源代码文件的顶部都有说明。在极少数情况下，如果你贡献的变更包含新的源文件，请确保适当填写头部信息。

对于 Swift 源文件，代码头部应该如下所示：

~~~~swift
//===----------------------------------------------------------------------===//
//
// This source file is part of the Swift.org open source project
//
// Copyright (c) {{site.time | date: "%Y"}} Apple Inc. and the Swift project authors
// Licensed under Apache License v2.0 with Runtime Library Exception
//
// See https://swift.org/LICENSE.txt for license information
// See https://swift.org/CONTRIBUTORS.txt for the list of Swift project authors
//
//===----------------------------------------------------------------------===//
~~~~

对于 C 或 C++ 源文件或头文件，代码头部应该如下所示：

~~~~cpp
//===-- subfolder/Filename.h - Very brief description -----------*- C++ -*-===//
//
// This source file is part of the Swift.org open source project
//
// Copyright (c) {{site.time | date: "%Y"}} Apple Inc. and the Swift project authors
// Licensed under Apache License v2.0 with Runtime Library Exception
//
// See https://swift.org/LICENSE.txt for license information
// See https://swift.org/CONTRIBUTORS.txt for the list of Swift project authors
//
//===----------------------------------------------------------------------===//
///
/// \file
/// This file contains stuff that I am describing here in the header and will
/// be sure to keep up to date.
///
//===----------------------------------------------------------------------===//
~~~~

分隔线应该正好是 80 个字符宽，以帮助遵守代码风格指南。底部部分包含用于生成文档的可选描述（这些行以 `///` 开头，而不是 `//`）。如果没有描述，可以跳过这个区域。

### 发布分支拉取请求

针对发布分支（`release/x.y` 或 `swift/release/x.y`）的拉取请求在没有相应分支管理员的 GitHub 批准的情况下不能合并。为了使变更被考虑纳入发布分支，拉取请求必须：

* 标题以包含目标分支发布版本号的标识开头。

* 在其描述中填写[此][form]表单。不适用的项目可以留空或填写相应说明，但不能完全省略。

  在浏览器中为 [swiftlang][swiftlang] 仓库起草拉取请求时，要切换到此模板，请在当前 URL 后附加 `template=release.md` 查询参数并刷新。
  例如：
  ```diff
  -https://github.com/swiftlang/swift/compare/main...my-branch?quick_pull=1
  +https://github.com/swiftlang/swift/compare/main...my-branch?quick_pull=1&template=release.md
  ```

[这里](https://github.com/swiftlang/swift/pull/73697)是一个示例。

[swiftlang]: https://github.com/swiftlang
[form]: https://github.com/swiftlang/.github/blob/main/PULL_REQUEST_TEMPLATE/release.md?plain=1

### 代码审查

Swift 项目高度依赖代码审查来提高软件质量：

* 所有开发者的所有重要变更在提交到仓库之前都必须经过审查。较小的变更（或开发者拥有该组件的变更）可以在提交后进行审查。
* 代码审查在 GitHub 上进行（通过对拉取请求或提交的评论），并反映在相关项目的提交邮件列表中。
* 负责代码变更的开发者也负责进行所有必要的审查相关的变更。

代码审查可以是一个迭代过程，直到变更准备好提交为止。在变更发送审查后，它需要明确的批准才能提交。不要假定默认批准或通过设置截止日期来请求对补丁的主动反对。

有时代码审查会花费比你希望更长的时间，特别是对于较大的功能。以下是一些加快审查时间的公认方法：

* **审查其他人的变更。**如果你帮助别人，每个人都会更愿意为你做同样的事。善意是我们的货币。
* **将你的变更分成多个较小的变更。**你的变更越小，有人快速查看它的可能性就越大。
* **催促变更。**如果很紧急，说明为什么尽快合并这个变更很重要，并每隔几天催促一次。如果不紧急，通常的礼貌催促频率是一周一次。记住，你是在请求其他专业开发者的宝贵时间。

请注意，任何人都欢迎审查和提供反馈，但只有对仓库有提交权限的人才能批准它。

### 测试

开发者需要为修复的任何错误和添加的任何新功能创建测试用例，并将它们与变更一起提交。

* 所有功能和回归测试用例都添加到适当的测试目录中---例如，`swift/test` 目录。
* 在最接近实际功能的抽象层次编写测试用例。例如，如果是 Swift 语言功能，就用 Swift 编写；如果是 SIL 优化，就用 SIL 编写。
* 尽可能减少测试用例，特别是对于回归测试。将整个失败的程序放入 `swift/test` 是不可接受的，因为这会降低所有开发者的测试速度。请保持简短。

### 质量

人们依靠 Swift 来创建他们的生产软件。这意味着 Swift 中的一个错误可能会导致成千上万，甚至数百万开发者的产品出现错误。因此，Swift 项目保持着高质量标准。在提交到主开发分支之前，任何变更必须满足的最低质量标准包括：

1. 代码必须在至少一个平台上编译时没有错误或警告。
2. 错误修复和新功能必须包含测试用例以发现任何未来的回归，或者包含说明为什么测试用例不切实际的理由。
3. 代码必须通过适当的测试套件---例如，Swift 编译器中的 `swift/test` 和 `swift/validation-test` 测试套件。

此外，提交者负责解决变更可能在未来造成的任何问题。这种责任意味着你可能需要更新你的变更以：

* 确保代码在所有主要平台上都能干净地编译。
* 修复在其他测试套件中发现的任何正确性回归。
* 修复任何主要性能回归。
* 修复下游 Swift 工具中的任何性能或正确性回归。
* 修复使用 Swift 的客户代码中出现的任何性能或正确性回归。
* 解决由于你的变更而在错误跟踪器中出现的任何错误。

我们希望这些问题在提交之前就能解决，但我们理解不可能对每个提交都进行所有这些测试。我们的持续集成（CI）基础设施通常会发现这些问题。我们建议在接下来的一天里关注 CI 基础设施以查找回归。如果包含你的提交的一组提交导致失败，CI 基础设施会直接给你发送电子邮件。你应该检查这些消息，看看是否是你的错，如果是，就修复这些问题。

明显违反这些质量标准的提交可能会被还原，特别是当变更阻碍其他开发者取得进展时。在问题解决后，欢迎开发者重新提交变更。

### 提交权限

提交权限授予给有提交高质量变更记录的贡献者。如果你想获得提交权限，请向[代码所有者列表](mailto:code-owners@forums.swift.org)发送电子邮件，说明你想使用的 GitHub 用户名，并列出 5 个被接受且无需修改的非平凡拉取请求。

一旦你获得了提交权限，你将能够向托管 Swift.org 项目的所有 GitHub 仓库提交代码。要验证你的提交权限是否有效，请进行测试提交（例如，更改注释或添加空行）。以下政策适用于具有提交权限的用户：

* 你被授予对 Swift 所有部分的批准后提交权限。要获得批准，创建一个拉取请求。当拉取请求被批准后，你可以自己合并它。

* 你可以在未经事先批准的情况下提交明显的变更。社区期望你运用良好的判断。例如，还原明显损坏的补丁、更正代码注释和其他小变更。

* 你可以在未经批准的情况下向你已贡献或被分配责任的 Swift 部分提交变更。这些提交不得破坏构建。这是一个"信任但验证"的政策，此类提交在提交后进行审查。

多次违反这些政策或单次严重违反可能导致提交权限被撤销。即使有提交权限，你的变更仍然需要经过[代码审查](#code-review)。当然，我们也鼓励你审查其他人的变更。

[community]: /community  "Swift.org 社区概述"
[get_started]: /getting-started/ "如何设置你自己的 Swift 版本"